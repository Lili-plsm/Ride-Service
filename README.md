## Uber-подобный сервис такси, реализованный по принципу модульного монолита с асинхронной коммуникацией сервисов через Kafka и расчетом оптимальных маршрутов через OSRM API

---

### Основные возможности API

- Создание клиентов и водителей.
- Клиент может отправить запрос на создание поездки.
- Сервис автоматически подбирает водителя, который свободен и находится ближе всех к клиенту.
- Расчёт близости маршрута осуществляется с помощью открытого API OSRM, учитывающего широту, долготу и форму дорог.
- При освобождении водителя ему автоматически подбирается ближайший клиент.

---

### Архитектура и взаимодействие сервисов

- Приложение разделено на сервисы для работы с:
  - таблицами клиентов,
  - водителей,
  - поездок,
  - оплаты.
- Взаимодействие сервисов происходит через Kafka.
- Реализована архитектура web-domain-datasource.
- Модуль безопасности обеспечивает авторизацию через JWT-токены.

---

### Дополнительные возможности API

- Получение данных о текущей поездке для клиента и водителя.
- Получение ID текущего пользователя.

---

### Безопасность и аутентификация

- Аутентификация через JWT access и refresh токены.
- Пароли пользователей хранятся в базе данных в зашифрованном (хешированном) виде с использованием надёжного алгоритма хеширования.




## Технологии и стек

- **Spring Boot**
- **Spring Web**  
- **Spring Data JPA**  
- **Spring Security**  
- **PostgreSQL**  
- **JJWT**  
- **SpringDoc OpenAPI**  
- **Kafka**  
- **Gradle** 
- **Docker** 
- **Docker Compose** 
- **CI/CD (Jenkins)** 

---

## Установка и запуск

Для запуска проекта используются Docker и Docker Compose.
Для автоматического запуска сборки, тестов и деплоя используется файл Jenkins.
Настройка:
Склонируйте репозиторий на сервер/машину, где работает Jenkins. В файле Jenkinsfile укажите путь к проекту:

```bash
environment {
    PROJECT_DIR = "/путь/до/вашего/проекта"
}
```
Замените "/путь/до/вашего/проекта" на свой локальный путь, где находится проект.

Убедитесь, что на машине с Jenkins установлены docker, docker compose


Jenkins автоматически выполнит следующие шаги:

Build, Test, Run 

После завершения пайплайна Jenkins автоматически удалит все контейнеры и тома.

Для запуска тестов надо выполнить в терминале

```bash
docker compose -f docker-compose.test.yml up --build --abort-on-container-exit --exit-code-from app
```

После прерывания процесса:
```bash
docker compose -f docker-compose.test.yml down -v
```

Для запуска приложения
```bash
docker compose -f docker-compose.prod.yml up --build
```

После прерывания процесса:
```bash
docker compose -f docker-compose.prod.yml down -v
```
---

## Документация API

Полная спецификация API представлена в файле [`api-documentation.yaml`](./api-documentation.yaml)

---
# Эндпоинты API

## 1. Создание клиента и водителя
На данном этапе проекта любой пользователь по умолчанию является клиентом.  
Создание клиента через эндпоинт позволяет занести в базу данных дополнительную информацию о нём.


### `POST /drivers` — создание водителя

**Тело запроса:**
```jsonc
{
  "carModel": "модель автомобиля",      // Обязательное поле, не длиннее 50 символов
  "carNumber": "госномер",               // Обязательное поле, формат: ^[А-ЯA-Z0-9-]{5,12}$
  "status": "статус водителя",				
  "latitude": "широта",                  // Тип double
  "longitude": "долгота"                  // Тип double
}
```

**Пример запроса:**
```jsonc
{
  "carModel": "Toyota Camry",
  "carNumber": "А123ВС777",
  "status": "FREE",
  "latitude": 59.9311,
  "longitude": 30.3609
}
```

**Пример ответа:**
```json
{
  "message": "Водитель создан"
}
```

---

## 2. Получение информации о текущей поездке

### `GET /clients/rides/current` — для клиента  
### `GET /drivers/rides/current` — для водителя  

Оба эндпоинта возвращают JSON одинакового формата:

**Пример ответа:**
```jsonc
{
  "rideId": "id поездки",
  "status": "статус поездки",
  "createdAt": "дата и время создания",
  "message": "описание поездки"
}
```

---

## 3. Создание поездки клиентом

### `POST /clients/rides` — создание новой поездки

**Тело запроса:**
```jsonc
{
  "rideStatus": "REQUESTED",              // Обязательное поле для создания
  "startLatitude": 59.9342802,            // Широта начала, тип double
  "startLongitude": 30.3350986,           // Долгота начала, тип double
  "endLatitude": 59.9700000,              // Широта конца, тип double
  "endLongitude": 30.4100000,            // Долгота конца, тип double
}
```

**Пример ответа:**
```jsonc
{
  "message": "Запрос на поездку создан"
}
```

---

## 4. Запрос поездки водителем

### `POST /drivers/rides` — запросить поездку
Тело запроса отсутствует.

**Пример ответа:**
```jsonc
{
  "message": "Запрос на поездку создан"
}
```

---

## 5. Информация о пользователе

- `GET /users/current/id` — возвращает `id` текущего пользователя

## Аутентификация

Аутентификация реализована через **JWT** access и refresh токены.

### Открытые эндпоинты

#### `POST /auth` — авторизация

**Пример запроса:**
```jsonc
{
  "login": "lili",
  "password": "ssw0rd"
}
```

#### `POST /register` — регистрация нового пользователя

**Пример запроса:**
```jsonc
{
  "login": "lili",
  "password": "ssw0rd"
}
```
В случае успеха возвращается код 201.

#### `POST /update_refresh` — обновление refresh токена  
Передаётся текущий refresh токен в заголовке запроса.

#### `POST /update_access` — обновление access токена  
Передаётся текущий refresh токен в заголовке запроса.

---

## Тесты

В проекте реализованы базовые тесты для проверки основных API:

- Регистрация пользователя.
- Проверяется успешная аутентификация и получение токена.
- Проверяется доступ к защищённым эндпоинтам с валидным токеном, включая эндпоинт создания клиента, водителя, запроса на поездку от пользователя и от водителя.
- Убеждаемся, что API возвращает успешный статус (200 OK) для корректных запросов, а также нужный статус поездки.

В тестах используется тестовая база данных.

Все тесты находятся в папке src/test/java/ru/site/web/controller

Для запуска тестов используется команда:
```bash
 ./gradlew test
```


## Контакты

- Telegram: [@mexaust](https://t.me/mexaust)  
- Email: [ssyp06510@gmail.com](mailto:ssyp06510@gmail.com)